# =========================================================
# Flutter Build Workflow
# =========================================================
# Builds APK on successful test completion (master branch)
# Triggered automatically when tests complete successfully
# =========================================================

name: "ðŸ—ï¸ Flutter Build"

on:
  workflow_run:
    workflows: ["ðŸ§ª Flutter Tests"]
    types:
      - completed
    branches:
      - master

env:
  FLUTTER_VERSION: '3.29.0'
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'zulu'

jobs:
  build:
    name: "ðŸ—ï¸ Build Android APK"
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“± Send Build Stage Notification"
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ðŸ—ï¸ *Stage 2/3: Build Started*
          ðŸ“‚ Repository: `${{ github.repository }}`
          ðŸ”— [View Progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

    - name: "ðŸ“¥ Checkout Repository"
      uses: actions/checkout@v3
      
    - name: "â˜• Setup Java Environment"
      uses: actions/setup-java@v3
      with:
        distribution: ${{ env.JAVA_DISTRIBUTION }}
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: "ðŸ“± Setup Flutter SDK"
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: "ðŸ“¦ Install Dependencies"
      run: flutter pub get
      
    - name: "ðŸ—ï¸ Build Release APK"
      run: flutter build apk --release
    
    - name: "ðŸ’¾ Extract App Version"
      id: version
      run: |
        VERSION=$(grep "version:" pubspec.yaml | awk '{print $2}')
        echo "app_version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: "ðŸ“¤ Upload APK Artifact"
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 1

    - name: "ðŸ“± Send Build Results Notification"
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ${{ job.status == 'success' && 'âœ… *Build Completed Successfully*' || 'âŒ *Build Failed*' }}
          ðŸ“‚ Repository: `${{ github.repository }}`
          ðŸ“Š Version: `${{ steps.version.outputs.app_version }}`
          ðŸ”— [View Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
      
    - name: "ðŸ”– Create Build Info"
      if: success()
      run: |
        echo "${{ github.run_id }}" > build_success.txt
        echo "${{ steps.version.outputs.app_version }}" > version.txt
      
    - name: "ðŸ“¤ Upload Build Info"
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: build-success-marker
        path: |
          build_success.txt
          version.txt
        retention-days: 1