name: "ğŸš€ Create Release"

on:
  workflow_run:
    workflows: ["ğŸ› ï¸ Flutter Build"]
    types:
      - completed
    branches:
      - master

jobs:
  release:
    name: "ğŸš€ Create GitHub Release"
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: "ğŸ“± Send Release Stage Notification"
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ğŸš€ *Stage 3/3: Release Started*
          ğŸ“‚ Repository: `${{ github.repository }}`
          ğŸ”— [View Progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

    - name: "ğŸ‘… Checkout Repository"
      uses: actions/checkout@v3
    
    - name: "ğŸ‘… Download Version Info"
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: "ğŸ› ï¸ Flutter Build"
        workflow_conclusion: success
        name: build-success-marker
        path: ./
        
    - name: "ğŸ“Š Get App Version"
      id: get_version
      run: |
        VERSION=$(cat version.txt)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    # Retrieve APK from build job
    - name: "ğŸ‘… Download APK from Build Job"
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: "ğŸ› ï¸ Flutter Build"
        workflow_conclusion: success
        name: release-apk
        path: apk
        
    - name: "ğŸ·ï¸ Create GitHub Release"
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: "apk/app-release.apk"
        prerelease: false
        draft: false
        tag: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸš€ Release v${{ steps.get_version.outputs.version }}
          
          ### ğŸ“± Downloads
          - [Download APK](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/app-release.apk)

    - name: "ğŸ“± Send Release Results Notification"
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ${{ job.status == 'success' && 'âœ… *Release Created Successfully*' || 'âŒ *Release Failed*' }}
          ğŸ“‚ Repository: `${{ github.repository }}`
          ğŸ“Š Version: `v${{ steps.get_version.outputs.version }}`
          ${{ job.status == 'success' && 'ğŸ”— [Download APK](https://github.com/' || '' }}${{ job.status == 'success' && github.repository || '' }}${{ job.status == 'success' && '/releases/download/v' || '' }}${{ job.status == 'success' && steps.get_version.outputs.version || '' }}${{ job.status == 'success' && '/app-release.apk)' || '' }}
          ${{ job.status == 'success' && 'ğŸ“ [View Release](https://github.com/' || '' }}${{ job.status == 'success' && github.repository || '' }}${{ job.status == 'success' && '/releases/tag/v' || '' }}${{ job.status == 'success' && steps.get_version.outputs.version || '' }}${{ job.status == 'success' && ')' || '' }}
